<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Genre Tagger</title>
    <link rel="stylesheet" href="/static/style.css">
    <script src="https://cdn.jsdelivr.net/npm/ag-grid-community/dist/ag-grid-community.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3@7/dist/d3.min.js"></script>
</head>
<body>

<header>
    <h1>Genre Tagger</h1>
    <div id="artwork-warm-status" class="artwork-warm-status hidden"></div>
    <div id="dropbox-status" class="dropbox-status">
        <span id="dropbox-status-text">Dropbox</span>
        <button id="dropbox-connect-btn" class="btn btn-sm dropbox-btn" onclick="connectDropbox()">Connect</button>
        <button id="dropbox-disconnect-btn" class="btn btn-sm dropbox-btn-disconnect hidden" onclick="disconnectDropbox()">Disconnect</button>
    </div>
    <nav id="tab-bar" class="tab-bar hidden">
        <button class="tab-btn active" data-tab="setbuilder">Set Workshop</button>
        <button class="tab-btn" data-tab="sets">Sets</button>
        <button class="tab-btn" data-tab="tagger">Tagger</button>
        <button class="tab-btn" data-tab="intersections">Intersections</button>
        <button class="tab-btn" data-tab="workshop">Playlist Workshop</button>
        <button class="tab-btn" data-tab="tree">Collection Tree</button>
    </nav>
</header>

<main>
    <!-- ═══ Tab: Tagger (existing content) ═══ -->
    <div id="tab-tagger" class="tab-content hidden">
        <!-- Upload Area -->
        <div id="upload-area" class="upload-area">
            <p>Drag &amp; drop a CSV file here, or <label for="file-input" class="file-label">browse</label></p>
            <input type="file" id="file-input" accept=".csv" hidden>
        </div>

        <!-- Summary -->
        <div id="summary" class="summary hidden">
            <span id="summary-total">0 tracks</span>
            <span class="sep">&middot;</span>
            <span id="summary-tagged" class="tagged-count">0 tagged</span>
            <span class="sep">&middot;</span>
            <span id="summary-untagged" class="untagged-count">0 untagged</span>
        </div>

        <!-- Toolbar -->
        <div id="toolbar" class="toolbar hidden">
            <button id="btn-tag-all" class="btn btn-primary">Tag All</button>
            <button id="btn-stop" class="btn btn-danger hidden">Stop</button>
            <button id="btn-clear-all" class="btn btn-secondary">Clear All</button>
            <button id="btn-export" class="btn btn-secondary">Export CSV</button>
            <button id="btn-settings" class="btn btn-secondary">Settings</button>
        </div>

        <!-- Progress Bar -->
        <div id="progress-container" class="progress-container hidden">
            <div id="progress-bar" class="progress-bar"></div>
        </div>

        <!-- Live Genre Chart -->
        <div id="genre-chart" class="genre-chart hidden"></div>

        <!-- Track Grid (AG Grid) -->
        <div id="track-grid" style="width:100%;"></div>
    </div>

    <!-- ═══ Tab: Intersections (Lineage DNA Chord Diagram) ═══ -->
    <div id="tab-intersections" class="tab-content hidden">
        <!-- Intersection Playlist Cards (appear after Generate Playlists) -->
        <div id="ix-cards-grid" class="trees-grid hidden"></div>

        <!-- Chord Diagram Section -->
        <section class="ws-section">
            <div class="ws-section-header">
                <h2>Lineage DNA</h2>
                <span id="chord-status" class="ws-status-text"></span>
            </div>

            <!-- Tree type toggle -->
            <div class="chord-type-selector">
                <button class="chord-type-btn active" data-tree-type="genre">Genre Tree</button>
                <button class="chord-type-btn" data-tree-type="scene">Scene Tree</button>
            </div>

            <!-- Controls -->
            <div class="chord-controls">
                <div class="chord-control-group">
                    <label for="chord-threshold">DNA Threshold:</label>
                    <input type="range" id="chord-threshold" min="0.03" max="0.25" step="0.01" value="0.08">
                    <span id="chord-threshold-val" class="chord-control-val">8%</span>
                </div>
                <div class="chord-control-group">
                    <label for="chord-max-lineages">Max Lineages:</label>
                    <input type="range" id="chord-max-lineages" min="4" max="20" step="1" value="12">
                    <span id="chord-max-lineages-val" class="chord-control-val">12</span>
                </div>
            </div>

            <!-- Chord SVG Container -->
            <div id="chord-container" class="chord-container">
                <p class="ws-placeholder">Loading lineage data...</p>
            </div>
        </section>
    </div>

    <!-- ═══ Tab: Playlist Workshop ═══ -->
    <div id="tab-workshop" class="tab-content hidden">

        <!-- LLM Suggestions Section -->
        <section class="ws-section">
            <div class="ws-section-header">
                <h2>Playlist Suggestions</h2>
                <button id="ws-btn-suggest" class="btn btn-primary btn-sm">Explore Collection</button>
            </div>
            <div class="ws-vibe-input">
                <label for="ws-vibe-text">Describe a vibe:</label>
                <div class="ws-vibe-row">
                    <input type="text" id="ws-vibe-text" placeholder='e.g. "sunset rooftop party", "dark warehouse techno", "chill Sunday morning grooves"' class="ws-text-input ws-vibe-field">
                    <button id="ws-btn-vibe-suggest" class="btn btn-primary btn-sm">Create from Vibe</button>
                </div>
            </div>
            <div id="ws-suggestions-list" class="ws-suggestions-list">
                <p class="ws-placeholder">Use "Explore Collection" for broad suggestions, "Create from Vibe" to describe a mood, select tracks below to generate from seeds, or click a heatmap cell to explore an intersection.</p>
            </div>
        </section>

        <!-- Faceted Search Section -->
        <section class="ws-section">
            <div class="ws-section-header">
                <h2>Search Tracks</h2>
            </div>
            <div id="ws-filters" class="ws-filters"></div>
            <div id="ws-search-results" class="ws-search-results"></div>
        </section>

        <!-- Playlist Builder Section -->
        <section class="ws-section">
            <div class="ws-section-header">
                <h2>My Playlists</h2>
                <button id="ws-btn-new-playlist" class="btn btn-primary btn-sm">New Playlist</button>
            </div>
            <div class="ws-playlists-layout">
                <div id="ws-playlist-sidebar" class="ws-playlist-sidebar">
                    <p class="ws-placeholder ws-playlist-empty">No playlists yet. Create one from a suggestion or search results.</p>
                </div>
                <div id="ws-playlist-detail" class="ws-playlist-detail"></div>
            </div>
        </section>

    </div>

    <!-- ═══ Tab: Collection Tree ═══ -->
    <div id="tab-tree" class="tab-content hidden">

        <!-- Tree type selector -->
        <div class="tree-type-selector">
            <button class="tree-type-btn active" data-tree-type="genre">Genre Tree</button>
            <button class="tree-type-btn" data-tree-type="scene">Scene Tree</button>
        </div>

        <!-- Build state: shown when no tree exists -->
        <div id="tree-build-section">
            <div class="tree-intro">
                <h2 id="tree-intro-title">Genre Tree</h2>
                <p id="tree-intro-desc">Build an interactive map of the musical lineages and evolutionary paths in your collection. Organises by genre family trees — broad traditions that branch into sub-genres and movements.</p>
                <button id="tree-build-btn" class="btn btn-primary btn-lg">Build Genre Tree</button>
            </div>
            <!-- Progress: shown during build -->
            <div id="tree-progress" class="tree-progress hidden">
                <div class="tree-progress-header">
                    <h3 id="tree-progress-phase">Analyzing collection...</h3>
                    <button id="tree-stop-btn" class="btn btn-danger btn-sm">Stop</button>
                </div>
                <div class="tree-progress-bar-container">
                    <div id="tree-progress-bar" class="tree-progress-bar"></div>
                </div>
                <p id="tree-progress-detail" class="tree-progress-detail"></p>
            </div>
        </div>

        <!-- Tree view: shown when tree exists -->
        <div id="tree-view-section" class="hidden">
            <div id="tree-header" class="tree-header"></div>
            <div class="tree-toolbar">
                <button id="tree-create-all-btn" class="btn btn-primary btn-sm">Create All Playlists</button>
                <button id="tree-rebuild-btn" class="btn btn-secondary btn-sm">Rebuild Tree</button>
            </div>
            <div id="tree-grid" class="trees-grid"></div>
            <div id="tree-ungrouped" class="tree-ungrouped-section"></div>
        </div>

    </div>

    <!-- ═══ Tab: Saved Sets ═══ -->
    <div id="tab-sets" class="tab-content hidden">
        <div class="sets-header">
            <h2>Saved Sets</h2>
            <button id="sets-new-btn" class="btn btn-primary btn-sm">New Set</button>
        </div>
        <div id="sets-grid" class="sets-grid">
            <p class="sets-empty">No saved sets yet. Build a set in the Set Workshop and save it.</p>
        </div>
    </div>

    <!-- ═══ Tab: Set Workshop ═══ -->
    <div id="tab-setbuilder" class="tab-content">

        <!-- Toolbar -->
        <div class="set-toolbar">
            <div class="set-toolbar-left">
                <span class="set-toolbar-title">Set Workshop</span>
            </div>
            <div class="set-toolbar-right">
                <span id="set-current-name" class="set-current-name"></span>
                <button id="set-save-btn" class="btn btn-secondary btn-sm" style="display:none;">Save</button>
                <button id="set-save-as-btn" class="btn btn-secondary btn-sm">Save As</button>
                <span class="set-toolbar-sep"></span>
                <button id="set-search-btn" class="btn btn-secondary btn-sm">Search</button>
                <button id="set-preview-all-btn" class="btn btn-secondary btn-sm" disabled>Preview All</button>
                <div class="set-mode-toggle">
                    <button id="set-mode-workshop" class="set-mode-btn active">Workshop Mode</button>
                    <button id="set-mode-playset" class="set-mode-btn" disabled>Play Mode</button>
                </div>
                <button id="set-export-btn" class="btn btn-secondary btn-sm" disabled>Export M3U</button>
            </div>
        </div>

        <!-- Set Grid: always visible (starts empty) -->
        <div id="set-grid-wrapper" class="set-grid-wrapper">
            <div id="set-grid-scroll" class="set-grid-scroll">
              <div class="set-grid-content">

                <!-- Slot Headers (source indicators + controls) -->
                <div class="set-slot-headers-area">
                    <div class="set-row-label">Source</div>
                    <div id="set-slot-headers" class="set-slot-headers"></div>
                </div>

                <!-- BPM Grid + Track Columns -->
                <div class="set-bpm-area">
                    <div class="set-bpm-axis">
                        <span class="set-bpm-label" data-bpm="150">150</span>
                        <span class="set-bpm-label" data-bpm="130">130</span>
                        <span class="set-bpm-label" data-bpm="110">110</span>
                        <span class="set-bpm-label" data-bpm="90">90</span>
                        <span class="set-bpm-label" data-bpm="70">70</span>
                    </div>
                    <div id="set-bpm-grid" class="set-bpm-grid">
                        <svg id="set-energy-svg" class="set-energy-svg"></svg>
                        <div id="set-columns" class="set-columns"></div>
                    </div>
                </div>

                <!-- Key Row -->
                <div class="set-key-area">
                    <div class="set-row-label">Key</div>
                    <div id="set-key-row" class="set-key-row"></div>
                </div>

                <!-- Preview Row -->
                <div class="set-preview-area">
                    <div class="set-row-label"></div>
                    <div id="set-preview-row" class="set-preview-row"></div>
                </div>

                <!-- Time Labels -->
                <div class="set-time-area">
                    <div class="set-row-label"></div>
                    <div id="set-time-row" class="set-time-row"></div>
                </div>

              </div>
            </div>
        </div>
    </div>

</main>

<!-- Set Workshop Drawer (right-hand slide-out) -->
<div id="set-drawer" class="set-drawer">
    <div class="set-drawer-inner">
        <div class="set-drawer-header">
            <h3 id="set-drawer-title">Source Browser</h3>
            <button id="set-drawer-close" class="btn btn-sm btn-secondary">Close</button>
        </div>

        <!-- Browse Mode -->
        <div id="set-drawer-browse" class="set-drawer-section hidden">
            <input type="text" id="set-drawer-search" class="set-drawer-search" placeholder="Search playlists and tree nodes...">
            <div id="set-drawer-playlists" class="set-drawer-list"></div>
            <div id="set-drawer-scene-tree" class="set-drawer-tree"></div>
            <div id="set-drawer-genre-tree" class="set-drawer-tree"></div>
        </div>

        <!-- Detail Mode -->
        <div id="set-drawer-detail" class="set-drawer-section hidden">
            <div id="set-drawer-detail-header" class="set-drawer-detail-header"></div>
            <div id="set-drawer-detail-tracks" class="set-drawer-track-list"></div>
        </div>

        <!-- Track Search Mode -->
        <div id="set-drawer-search-mode" class="set-drawer-section hidden">
            <input type="text" id="set-drawer-track-search" class="set-drawer-search"
                   placeholder="Search by title or artist...">
            <div id="set-drawer-search-results" class="set-drawer-track-list"></div>
            <div id="set-drawer-selected-track" class="set-drawer-selected-track hidden"></div>
            <div id="set-drawer-search-context" class="set-drawer-search-context hidden">
                <div id="set-search-card-scene" class="set-search-card"></div>
                <div id="set-search-card-genre" class="set-search-card"></div>
            </div>
        </div>

        <!-- Now Playing Mode -->
        <div id="set-drawer-now-playing" class="set-drawer-section hidden">
            <div class="now-playing-artwork-container">
                <img id="now-playing-artwork" class="now-playing-artwork" alt="" src="">
            </div>
            <div class="now-playing-track-info">
                <div id="now-playing-title" class="now-playing-title"></div>
                <div id="now-playing-artist" class="now-playing-artist"></div>
                <div class="now-playing-meta">
                    <span id="now-playing-bpm"></span>
                    <span id="now-playing-key"></span>
                    <span id="now-playing-year"></span>
                </div>
            </div>
            <div id="now-playing-scene-leaf" class="set-search-card"></div>
            <div id="now-playing-genre-leaf" class="set-search-card"></div>
            <div class="now-playing-controls">
                <div class="now-playing-progress-container">
                    <div id="now-playing-progress-bar" class="now-playing-progress-bar">
                        <div id="now-playing-progress-fill" class="now-playing-progress-fill"></div>
                    </div>
                    <div class="now-playing-time">
                        <span id="now-playing-current-time">0:00</span>
                        <span id="now-playing-duration">0:00</span>
                    </div>
                </div>
                <div class="now-playing-buttons">
                    <button id="now-playing-prev" class="now-playing-btn" title="Previous">&#9664;&#9664;</button>
                    <button id="now-playing-play-pause" class="now-playing-btn now-playing-btn-main" title="Play/Pause">&#9654;</button>
                    <button id="now-playing-next" class="now-playing-btn" title="Next">&#9654;&#9654;</button>
                </div>
                <div id="now-playing-counter" class="now-playing-counter"></div>
            </div>
        </div>
    </div>
</div>

<!-- Settings Modal -->
<div id="settings-modal" class="modal-overlay hidden">
    <div class="modal">
        <h2>Settings</h2>
        <label for="cfg-model">Model</label>
        <select id="cfg-model">
            <optgroup label="Anthropic">
                <option value="claude-sonnet-4-5-20250929">Claude Sonnet 4.5</option>
                <option value="claude-haiku-4-5-20251001">Claude Haiku 4.5</option>
            </optgroup>
            <optgroup label="OpenAI">
                <option value="gpt-4">GPT-4</option>
                <option value="gpt-4o">GPT-4o</option>
                <option value="gpt-4o-mini">GPT-4o mini</option>
            </optgroup>
        </select>

        <label for="cfg-system-prompt">System Prompt</label>
        <textarea id="cfg-system-prompt" rows="3"></textarea>

        <label for="cfg-user-prompt">User Prompt Template</label>
        <textarea id="cfg-user-prompt" rows="6"></textarea>
        <p class="hint">Placeholders: <code>{title}</code> <code>{artist}</code> <code>{bpm}</code> <code>{key}</code> <code>{year}</code></p>

        <label for="cfg-delay">Delay between requests (seconds)</label>
        <input type="number" id="cfg-delay" min="0" step="0.5" value="1.5">

        <hr style="margin: 1rem 0; border-color: var(--border);">
        <label class="cfg-checkbox-label">
            <input type="checkbox" id="cfg-path-map-enabled">
            Map music folder to My G computer
        </label>
        <div id="cfg-path-map-fields" class="hidden" style="margin-top: 0.5rem;">
            <label for="cfg-path-from">From path prefix</label>
            <input type="text" id="cfg-path-from" style="width:100%; font-size:0.8rem;">
            <label for="cfg-path-to" style="margin-top:0.4rem;">To path prefix</label>
            <input type="text" id="cfg-path-to" style="width:100%; font-size:0.8rem;">
        </div>

        <div class="modal-actions">
            <button id="btn-cfg-save" class="btn btn-primary">Save</button>
            <button id="btn-cfg-reset" class="btn btn-secondary">Reset to Defaults</button>
            <button id="btn-cfg-close" class="btn btn-secondary">Cancel</button>
        </div>
    </div>
</div>

<!-- Add-to-Playlist Modal -->
<div id="add-to-playlist-modal" class="modal-overlay hidden">
    <div class="modal" style="max-width:400px">
        <h2>Add to Playlist</h2>
        <div id="atp-playlist-list" class="atp-playlist-list"></div>
        <div class="modal-actions">
            <button id="atp-cancel" class="btn btn-secondary">Cancel</button>
        </div>
    </div>
</div>

<script src="/static/app.js"></script>
<script src="/static/workshop.js"></script>
<script src="/static/tree.js"></script>
<script src="/static/setbuilder.js"></script>
</body>
</html>

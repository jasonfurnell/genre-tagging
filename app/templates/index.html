<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Genre Tagger</title>
    <link rel="stylesheet" href="/static/style.css">
    <script src="https://cdn.jsdelivr.net/npm/ag-grid-community/dist/ag-grid-community.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3@7/dist/d3.min.js"></script>
</head>
<body>

<header>
    <h1>Genre Tagger</h1>
    <nav id="tab-bar" class="tab-bar hidden">
        <button class="tab-btn active" data-tab="tagger">Tagger</button>
        <button class="tab-btn" data-tab="intersections">Intersections</button>
        <button class="tab-btn" data-tab="workshop">Playlist Workshop</button>
        <button class="tab-btn" data-tab="tree">Collection Tree</button>
    </nav>
</header>

<main>
    <!-- ═══ Tab: Tagger (existing content) ═══ -->
    <div id="tab-tagger" class="tab-content">
        <!-- Upload Area -->
        <div id="upload-area" class="upload-area">
            <p>Drag &amp; drop a CSV file here, or <label for="file-input" class="file-label">browse</label></p>
            <input type="file" id="file-input" accept=".csv" hidden>
        </div>

        <!-- Summary -->
        <div id="summary" class="summary hidden">
            <span id="summary-total">0 tracks</span>
            <span class="sep">&middot;</span>
            <span id="summary-tagged" class="tagged-count">0 tagged</span>
            <span class="sep">&middot;</span>
            <span id="summary-untagged" class="untagged-count">0 untagged</span>
        </div>

        <!-- Toolbar -->
        <div id="toolbar" class="toolbar hidden">
            <button id="btn-tag-all" class="btn btn-primary">Tag All</button>
            <button id="btn-stop" class="btn btn-danger hidden">Stop</button>
            <button id="btn-clear-all" class="btn btn-secondary">Clear All</button>
            <button id="btn-export" class="btn btn-secondary">Export CSV</button>
            <button id="btn-settings" class="btn btn-secondary">Settings</button>
        </div>

        <!-- Progress Bar -->
        <div id="progress-container" class="progress-container hidden">
            <div id="progress-bar" class="progress-bar"></div>
        </div>

        <!-- Live Genre Chart -->
        <div id="genre-chart" class="genre-chart hidden"></div>

        <!-- Track Grid (AG Grid) -->
        <div id="track-grid" style="width:100%;"></div>
    </div>

    <!-- ═══ Tab: Intersections (Lineage DNA Chord Diagram) ═══ -->
    <div id="tab-intersections" class="tab-content hidden">
        <!-- Intersection Playlist Cards (appear after Generate Playlists) -->
        <div id="ix-cards-grid" class="trees-grid hidden"></div>

        <!-- Chord Diagram Section -->
        <section class="ws-section">
            <div class="ws-section-header">
                <h2>Lineage DNA</h2>
                <span id="chord-status" class="ws-status-text"></span>
            </div>

            <!-- Tree type toggle -->
            <div class="chord-type-selector">
                <button class="chord-type-btn active" data-tree-type="genre">Genre Tree</button>
                <button class="chord-type-btn" data-tree-type="scene">Scene Tree</button>
            </div>

            <!-- Controls -->
            <div class="chord-controls">
                <div class="chord-control-group">
                    <label for="chord-threshold">DNA Threshold:</label>
                    <input type="range" id="chord-threshold" min="0.03" max="0.25" step="0.01" value="0.08">
                    <span id="chord-threshold-val" class="chord-control-val">8%</span>
                </div>
                <div class="chord-control-group">
                    <label for="chord-max-lineages">Max Lineages:</label>
                    <input type="range" id="chord-max-lineages" min="4" max="20" step="1" value="12">
                    <span id="chord-max-lineages-val" class="chord-control-val">12</span>
                </div>
            </div>

            <!-- Chord SVG Container -->
            <div id="chord-container" class="chord-container">
                <p class="ws-placeholder">Loading lineage data...</p>
            </div>
        </section>
    </div>

    <!-- ═══ Tab: Playlist Workshop ═══ -->
    <div id="tab-workshop" class="tab-content hidden">

        <!-- LLM Suggestions Section -->
        <section class="ws-section">
            <div class="ws-section-header">
                <h2>Playlist Suggestions</h2>
                <button id="ws-btn-suggest" class="btn btn-primary btn-sm">Explore Collection</button>
            </div>
            <div class="ws-vibe-input">
                <label for="ws-vibe-text">Describe a vibe:</label>
                <div class="ws-vibe-row">
                    <input type="text" id="ws-vibe-text" placeholder='e.g. "sunset rooftop party", "dark warehouse techno", "chill Sunday morning grooves"' class="ws-text-input ws-vibe-field">
                    <button id="ws-btn-vibe-suggest" class="btn btn-primary btn-sm">Create from Vibe</button>
                </div>
            </div>
            <div id="ws-suggestions-list" class="ws-suggestions-list">
                <p class="ws-placeholder">Use "Explore Collection" for broad suggestions, "Create from Vibe" to describe a mood, select tracks below to generate from seeds, or click a heatmap cell to explore an intersection.</p>
            </div>
        </section>

        <!-- Faceted Search Section -->
        <section class="ws-section">
            <div class="ws-section-header">
                <h2>Search Tracks</h2>
            </div>
            <div id="ws-filters" class="ws-filters"></div>
            <div id="ws-search-results" class="ws-search-results"></div>
        </section>

        <!-- Playlist Builder Section -->
        <section class="ws-section">
            <div class="ws-section-header">
                <h2>My Playlists</h2>
                <button id="ws-btn-new-playlist" class="btn btn-primary btn-sm">New Playlist</button>
            </div>
            <div class="ws-playlists-layout">
                <div id="ws-playlist-sidebar" class="ws-playlist-sidebar">
                    <p class="ws-placeholder ws-playlist-empty">No playlists yet. Create one from a suggestion or search results.</p>
                </div>
                <div id="ws-playlist-detail" class="ws-playlist-detail"></div>
            </div>
        </section>

    </div>

    <!-- ═══ Tab: Collection Tree ═══ -->
    <div id="tab-tree" class="tab-content hidden">

        <!-- Tree type selector -->
        <div class="tree-type-selector">
            <button class="tree-type-btn active" data-tree-type="genre">Genre Tree</button>
            <button class="tree-type-btn" data-tree-type="scene">Scene Tree</button>
        </div>

        <!-- Build state: shown when no tree exists -->
        <div id="tree-build-section">
            <div class="tree-intro">
                <h2 id="tree-intro-title">Genre Tree</h2>
                <p id="tree-intro-desc">Build an interactive map of the musical lineages and evolutionary paths in your collection. Organises by genre family trees — broad traditions that branch into sub-genres and movements.</p>
                <button id="tree-build-btn" class="btn btn-primary btn-lg">Build Genre Tree</button>
            </div>
            <!-- Progress: shown during build -->
            <div id="tree-progress" class="tree-progress hidden">
                <div class="tree-progress-header">
                    <h3 id="tree-progress-phase">Analyzing collection...</h3>
                    <button id="tree-stop-btn" class="btn btn-danger btn-sm">Stop</button>
                </div>
                <div class="tree-progress-bar-container">
                    <div id="tree-progress-bar" class="tree-progress-bar"></div>
                </div>
                <p id="tree-progress-detail" class="tree-progress-detail"></p>
            </div>
        </div>

        <!-- Tree view: shown when tree exists -->
        <div id="tree-view-section" class="hidden">
            <div id="tree-header" class="tree-header"></div>
            <div class="tree-toolbar">
                <button id="tree-create-all-btn" class="btn btn-primary btn-sm">Create All Playlists</button>
                <button id="tree-rebuild-btn" class="btn btn-secondary btn-sm">Rebuild Tree</button>
            </div>
            <div id="tree-grid" class="trees-grid"></div>
            <div id="tree-ungrouped" class="tree-ungrouped-section"></div>
        </div>

    </div>
</main>

<!-- Settings Modal -->
<div id="settings-modal" class="modal-overlay hidden">
    <div class="modal">
        <h2>Settings</h2>
        <label for="cfg-model">Model</label>
        <select id="cfg-model">
            <optgroup label="Anthropic">
                <option value="claude-sonnet-4-5-20250929">Claude Sonnet 4.5</option>
                <option value="claude-haiku-4-5-20251001">Claude Haiku 4.5</option>
            </optgroup>
            <optgroup label="OpenAI">
                <option value="gpt-4">GPT-4</option>
                <option value="gpt-4o">GPT-4o</option>
                <option value="gpt-4o-mini">GPT-4o mini</option>
            </optgroup>
        </select>

        <label for="cfg-system-prompt">System Prompt</label>
        <textarea id="cfg-system-prompt" rows="3"></textarea>

        <label for="cfg-user-prompt">User Prompt Template</label>
        <textarea id="cfg-user-prompt" rows="6"></textarea>
        <p class="hint">Placeholders: <code>{title}</code> <code>{artist}</code> <code>{bpm}</code> <code>{key}</code> <code>{year}</code></p>

        <label for="cfg-delay">Delay between requests (seconds)</label>
        <input type="number" id="cfg-delay" min="0" step="0.5" value="1.5">

        <div class="modal-actions">
            <button id="btn-cfg-save" class="btn btn-primary">Save</button>
            <button id="btn-cfg-reset" class="btn btn-secondary">Reset to Defaults</button>
            <button id="btn-cfg-close" class="btn btn-secondary">Cancel</button>
        </div>
    </div>
</div>

<!-- Add-to-Playlist Modal -->
<div id="add-to-playlist-modal" class="modal-overlay hidden">
    <div class="modal" style="max-width:400px">
        <h2>Add to Playlist</h2>
        <div id="atp-playlist-list" class="atp-playlist-list"></div>
        <div class="modal-actions">
            <button id="atp-cancel" class="btn btn-secondary">Cancel</button>
        </div>
    </div>
</div>

<script src="/static/app.js"></script>
<script src="/static/workshop.js"></script>
<script src="/static/tree.js"></script>
</body>
</html>
